<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Category Details</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-5">
    <h2>Product Details <span id="categoryId"></span></h2>
    <div class="container mt-5">
      <h2>Search Products</h2>
      <div class="form-group">
        <input
          type="text"
          id="searchQuery"
          class="form-control"
          placeholder="Search "
        />
        <button id="searchButton" class="btn btn-primary mt-2">Search</button>
      </div>
      <div class="mb-3">
        <select class="custom-select" id="categoryDropdown"></select>
      </div>


      <div>
          <button onclick="navigateBack()" class="btn btn-outline-primary mr-1 mb-2">
  Back
</button>

          </div>
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Brand</th>
                <th>Category Name</th>
                <th>MRP</th>
                <th>Discount Price</th>
                <th>Date Added</th>
            </tr>
        </thead>
        <tbody id="productsTableBody">
            <!-- Products will be dynamically filled here -->
        </tbody>
    </table>
    <div id="pagination" class="mt-3 mb-2 d-flex justify-content-center">
        <!--PAGINATION_CONTENT-->
      </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>



 function navigateBack() {
  window.history.back(); // Go back in the browser history
}

// Listen for popstate event to handle back/forward navigation
window.addEventListener('popstate', function(event) {
  // Reload the page or update content based on the current URL
  fetchProductDetails(getPageFromUrl());
});

// Function to extract page number from URL
function getPageFromUrl() {
  const urlParams = new URLSearchParams(window.location.search);
  return parseInt(urlParams.get('page')) || 1; // Default to page 1 if no page parameter is present
}


let currentPage = 1; // Initialize current page

document.addEventListener("DOMContentLoaded", function () {
    fetchCategories(); // Populate the categories dropdown
    fetchProductDetails(currentPage); // Fetch products for the initial page load or specific category
});

document.getElementById('categoryDropdown').addEventListener('change', function() {
    const selectedCategoryId = this.value;
    if (selectedCategoryId) {
        fetchProductDetails(1, selectedCategoryId); // Reset to the first page
    }
});

document.getElementById("searchButton").addEventListener("click", function () {
    const searchTerm = document.getElementById("searchQuery").value;
    window.location.href = `/search?query=${encodeURIComponent(searchTerm)}`;
});

function fetchCategories() {
    fetch('/category/json')
        .then(response => response.json())
        .then(data => {
            const dropdown = document.getElementById('categoryDropdown');
            dropdown.innerHTML = '<option value="">Select Category</option>'; // Default option
            data.categories.forEach(category => {
                // Assuming each category is an object with category_id and category_name properties
                const option = document.createElement('option');
                option.value = category.category_id; // Adjusted access to category_id
                option.textContent = category.category_name; // Adjusted access to category_name
                dropdown.appendChild(option);
            });
        })
        .catch(error => console.error("Error fetching categories:", error));
}

function fetchProductDetails(page = 1, categoryId = null) {
    categoryId = categoryId || window.location.pathname.split('/').pop();
    const url = `/details/${categoryId}/json?page=${page}`;
    fetch(url)
        .then(response => response.json())
        .then(data => {
            document.getElementById("categoryId").textContent = categoryId; // Or set this to data.categoryName if available
            displayProducts(data.products);
            updatePaginationControls(data.currentPage, data.totalPages);
        })
        .catch(error => console.error("Error fetching product details:", error));
}

function displayProducts(products) {
    const productsTableBody = document.getElementById("productsTableBody");
    productsTableBody.innerHTML = ""; // Clear existing products
    products.forEach(product => {
        const row = `<tr>
            <td>${product.product_id}</td>
            <td>${product.product_name}</td>
            <td>${product.brand}</td>
            <td>${product.categoryName}</td>
            <td>${product.MRP}</td>
            <td>${product.discount_price}</td>
            <td>${new Date(product.date_added).toLocaleDateString()}</td>
        </tr>`;
        productsTableBody.innerHTML += row;
    });
}

function updatePaginationControls(currentPage, totalPages) {
    const paginationDiv = document.getElementById("pagination");
    paginationDiv.innerHTML = ""; // Clear existing pagination

    // Add 'Previous' button if not on the first page
    if (currentPage > 1) {
        paginationDiv.innerHTML += `<button class="btn btn-outline-primary mr-2" onclick="changePage(${currentPage - 1})">Previous</button>`;
    }

    // Determine which page numbers to display
    let startPage = Math.max(1, currentPage - 1);
    let endPage = Math.min(totalPages, currentPage + 1);

    // Always show first page if not in range
    if (startPage > 1) {
        paginationDiv.innerHTML += `<button class="btn btn-outline-primary mr-1" onclick="changePage(1)">1</button>`;
        if (startPage > 2) {
            paginationDiv.innerHTML += `<span class="mr-1">...</span>`; // Ellipses for skipping several pages
        }
    }

    // Generate page numbers in the defined range
    for (let i = startPage; i <= endPage; i++) {
        if (i === currentPage) {
            paginationDiv.innerHTML += `<span class="btn btn-primary mr-1">${i}</span>`;
        } else {
            paginationDiv.innerHTML += `<button class="btn btn-outline-primary mr-1" onclick="changePage(${i})">${i}</button>`;
        }
    }

    // Always show last page if not in range
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationDiv.innerHTML += `<span class="mr-1">...</span>`; // Ellipses for skipping several pages
        }
        paginationDiv.innerHTML += `<button class="btn btn-outline-primary mr-1" onclick="changePage(${totalPages})">${totalPages}</button>`;
    }

    // Add 'Next' button if not on the last page
    if (currentPage < totalPages) {
        paginationDiv.innerHTML += `<button class="btn btn-outline-primary" onclick="changePage(${currentPage + 1})">Next</button>`;
    }
}

function changePage(page) {yId("categoryId").textContent || window.location.pathname.split('/').pop();
    fetchProductDetails(page, categoryId);
    // Update the URL in the browser's add
    const categoryId = document.getElementById("categoryId").textContent || window.location.pathname.split('/').pop();
    fetchProductDetails(page, categoryId);
    // Update the URL in the browser's address bar without reloading the page
    const newUrl = `/details/${categoryId}/?page=${page}`;
    window.history.pushState({path:newUrl}, '', newUrl);
}

</script>
</body>
</html>