<!-- products.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Products List</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
  </head>
  <body>
    <div class="container mt-5">
      <h2>Products List</h2>
      <div>
        <input
          type="text"
          id="searchQuery"
          class="form-control"
          placeholder="Search by"
        />
        <button id="searchButton" class="btn btn-primary mt-2 mb-2">
          Search
        </button>
      </div>

      <div class="mb-3">
        <select
          class="custom-select"
          id="categoryDropdown"
          onchange="navigateToCategory(this)"
        ></select>
      </div>

      <div style="display: flex" class="mb-2">
        <!--CATEGORY_DROPDOWN-->
        <div>
        <div>
          <button onclick="navigateBack()" class="btn btn-outline-primary mr-1">
  Back
</button>

          </div>
        </div>
      </div>
      <div id="productTable">
        <table class="table table-bordered table-hover striped">
          <thead class="thead-light">
            <tr>
              <th scope="col">Product ID</th>
              <th scope="col">Product Name</th>
              <th scope="col">Brand</th>
              <th scope="col">Category Name</th>
              <th scope="col">MRP</th>
              <th scope="col">Discount Price</th>
              <th scope="col">Date Added</th>
            </tr>
          </thead>
          <tbody>
            <!--TABLE_CONTENT-->
          </tbody>
        </table>
      </div>
      <div id="pagination" class="mt-3 mb-2 d-flex justify-content-center">
        <!--PAGINATION_CONTENT-->
      </div>
      <div>
        <div id="backButton" class="mb-2 ml-2"><!--BACK_BUTTON--></div>
      </div>
    </div>

    <!-- Include Bootstrap JS and its dependencies from CDN for interactive components (if needed) -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>

      function navigateBack() {
  window.history.back(); // Go back in the browser history
}

// Listen for popstate event to handle back/forward navigation
window.addEventListener('popstate', function(event) {
  // Reload the page or update content based on the current URL
  fetchProductData(getPageFromUrl());
});

// Function to extract page number from URL
function getPageFromUrl() {
  const urlParams = new URLSearchParams(window.location.search);
  return parseInt(urlParams.get('page')) || 1; // Default to page 1 if no page parameter is present
}






      document
        .getElementById("categoryDropdown")
        .addEventListener("change", function () {
          const selectedCategoryId = this.value;
          if (selectedCategoryId) {
            fetchProductDetails(1, selectedCategoryId); // Reset to the first page
          }
        });
      document
        .getElementById("searchButton")
        .addEventListener("click", function () {
          const searchTerm = document.getElementById("searchQuery").value;
          window.location.href = `/search?query=${encodeURIComponent(
            searchTerm
          )}`;
        });
      document.addEventListener("DOMContentLoaded", function () {
        fetchCategories();
        fetchProductData(); // Call without parameters to fetch all products
      });

      function fetchCategories() {
        fetch("/category/json")
          .then((response) => response.json())
          .then((data) => {
            const dropdown = document.getElementById("categoryDropdown");
            dropdown.innerHTML = '<option value="">Select Category</option>'; // Default option
            data.categories.forEach((category) => {
              // Assuming each category is an object with category_id and category_name properties
              const option = document.createElement("option");
              option.value = category.category_id; // Adjusted access to category_id
              option.textContent = category.category_name; // Adjusted access to category_name
              dropdown.appendChild(option);
            });
          })
          .catch((error) => console.error("Error fetching categories:", error));
      }

      function fetchProductData(page = 1) {
        // Assuming '/products/json' returns all products when no specific query parameters are provided
        const url = `/products/json?page=${page}`;

        fetch(url)
          .then((response) => response.json())
          .then((data) => {
            populateProductsTable(data.products); // Assuming the JSON response has a 'products' field
            updatePagination(data.currentPage, data.totalPages); // Assuming the JSON response contains pagination info
          })
          .catch((error) =>
            console.error("Error fetching product data:", error)
          );
      }
      const searchQuery = document.getElementById("searchedData").value || "";
      const url = `/products/json?categorySearch=${encodeURIComponent(
        searchQuery
      )}&page=${page}`; // Update URL as necessary

      fetch(url)
        .then((response) => response.json())
        .then((data) => {
          populateProductsTable(data.products);
          updatePagination(data.currentPage, data.totalPages);
        })
        .catch((error) => console.error("Error fetching product data:", error));

      function populateProductsTable(products) {
        const tableBody = document.querySelector("#productTable tbody");
        tableBody.innerHTML = ""; // Clear existing table rows

        products.forEach((product) => {
          const row = `
            <tr>
                <td>${product.product_id}</td>
            <td>${product.product_name}</td>
            <td>${product.brand}</td>
            <td>${product.categoryName}</td>
            <td>${product.MRP}</td>
            <td>${product.discount_price}</td>
            <td>${new Date(product.date_added).toLocaleDateString()}</td>
            </tr>
        `;
          tableBody.innerHTML += row;
        });
      }
      function navigateToCategory(categoryId) {
        if (categoryId.value !== "null")
          window.location.href = "/details/" + categoryId.value;
        else window.location.href = "/products";
      }
      function updatePagination(currentPage, totalPages) {
    const paginationDiv = document.getElementById("pagination");
    paginationDiv.innerHTML = ""; // Clear existing pagination

    // Add 'Previous' button if not on the first page
    if (currentPage > 1) {
        paginationDiv.innerHTML += `<button class="btn btn-outline-primary mr-2" onclick="changePage(${currentPage - 1})">Previous</button>`;
    }

    // Generate page numbers
    for (let i = 1; i <= totalPages; i++) {
        // Highlight the current page number and make it non-clickable
        if (i === currentPage) {
            paginationDiv.innerHTML += `<span class="btn btn-primary mr-1">${i}</span>`;
        } else {
            // Other page numbers are clickable
            paginationDiv.innerHTML += `<button class="btn btn-outline-primary mr-1" onclick="changePage(${i})">${i}</button>`;
        }
    }

    // Add 'Next' button if not on the last page
    if (currentPage < totalPages) {
        paginationDiv.innerHTML += `<button class="btn btn-outline-primary" onclick="changePage(${currentPage + 1})">Next</button>`;
    }
}

function changePage(page) {
  fetchProductData(page); // Make sure this is correctly fetching and updating the content based on the new page

  const newUrl = window.location.pathname + '?page=' + page;
  window.history.pushState({ path: newUrl }, '', newUrl);
}

    </script>
  </body>
</html>
